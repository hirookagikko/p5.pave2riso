<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>PathOffset Test - p5.pave2riso</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    pre { background: #f0f0f0; padding: 10px; white-space: pre-wrap; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <h1>PathOffset Test (p5.pave2riso)</h1>
  <div id="result"></div>
  <script type="module">
    // Required: paper.js 0.12.4 and paperjs-offset 1.0.8
    import paper from 'https://cdn.jsdelivr.net/npm/paper@0.12.4/+esm'
    import { PaperOffset } from 'https://cdn.jsdelivr.net/npm/paperjs-offset@1.0.8/+esm'
    import { Path } from 'https://cdn.jsdelivr.net/npm/@baku89/pave@0.7.1/+esm'
    import { PathOffset } from '../dist/p5.pave2riso.js'

    // Make dependencies available globally for PathOffset
    window.paper = paper
    window.PaperOffset = PaperOffset
    window.Path = Path

    const log = (msg, isError = false) => {
      const div = document.createElement('pre')
      div.className = isError ? 'error' : 'success'
      div.textContent = typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg
      document.getElementById('result').appendChild(div)
    }

    // Test execution
    try {
      log('=== Test 1: Rectangle offset (outward) ===')
      const rect = Path.rect([100, 100], [300, 200])
      log(`Original bounds: ${JSON.stringify(Path.bounds(rect))}`)

      const expanded = PathOffset(rect, 20)
      const expandedBounds = Path.bounds(expanded)
      log(`Offset +20 bounds: ${JSON.stringify(expandedBounds)}`)

      // Verify: original [100,100]-[300,200], offset +20 should be [80,80]-[320,220]
      const expectedMin = [80, 80]
      const expectedMax = [320, 220]
      const tolerance = 1 // Allow small floating point error

      if (Math.abs(expandedBounds[0][0] - expectedMin[0]) < tolerance &&
          Math.abs(expandedBounds[0][1] - expectedMin[1]) < tolerance &&
          Math.abs(expandedBounds[1][0] - expectedMax[0]) < tolerance &&
          Math.abs(expandedBounds[1][1] - expectedMax[1]) < tolerance) {
        log('OK: Outward offset works correctly!')
      } else {
        log('FAIL: Bounds do not match expected values', true)
      }

      log('\n=== Test 2: Rectangle offset (inward) ===')
      const shrunk = PathOffset(rect, -10)
      const shrunkBounds = Path.bounds(shrunk)
      log(`Offset -10 bounds: ${JSON.stringify(shrunkBounds)}`)

      // Verify: original [100,100]-[300,200], offset -10 should be [110,110]-[290,190]
      const expectedShrunkMin = [110, 110]
      const expectedShrunkMax = [290, 190]

      if (Math.abs(shrunkBounds[0][0] - expectedShrunkMin[0]) < tolerance &&
          Math.abs(shrunkBounds[0][1] - expectedShrunkMin[1]) < tolerance &&
          Math.abs(shrunkBounds[1][0] - expectedShrunkMax[0]) < tolerance &&
          Math.abs(shrunkBounds[1][1] - expectedShrunkMax[1]) < tolerance) {
        log('OK: Inward offset works correctly!')
      } else {
        log('FAIL: Bounds do not match expected values', true)
      }

      log('\n=== Test 3: Circle offset ===')
      const circle = Path.circle([200, 200], 50)
      log(`Circle bounds: ${JSON.stringify(Path.bounds(circle))}`)

      const expandedCircle = PathOffset(circle, 20)
      const circleBounds = Path.bounds(expandedCircle)
      log(`Circle offset +20 bounds: ${JSON.stringify(circleBounds)}`)

      // Circle radius 50 at [200,200] -> bounds [150,150]-[250,250]
      // Offset +20 -> radius 70 -> bounds [130,130]-[270,270]
      const expectedCircleMin = [130, 130]
      const expectedCircleMax = [270, 270]

      if (Math.abs(circleBounds[0][0] - expectedCircleMin[0]) < tolerance &&
          Math.abs(circleBounds[0][1] - expectedCircleMin[1]) < tolerance &&
          Math.abs(circleBounds[1][0] - expectedCircleMax[0]) < tolerance &&
          Math.abs(circleBounds[1][1] - expectedCircleMax[1]) < tolerance) {
        log('OK: Circle offset works correctly!')
      } else {
        log('FAIL: Circle bounds do not match expected values', true)
      }

      log('\n=== All tests completed! ===')

    } catch (err) {
      log(`\nERROR: ${err.message}`, true)
      log(`Stack: ${err.stack}`, true)
    }
  </script>
</body>
</html>
