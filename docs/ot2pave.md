# ot2pave - フォントをパスに変換する仕組み

## 概要

`ot2pave` は、フォントの文字形状（OpenType.jsの出力）を、描画可能なパス（Pave.js形式）に変換する関数です。

## フォントの構造を理解する

### 文字は「輪郭」でできている

フォントの文字は、数学的な輪郭線（アウトライン）として定義されています。例えば「O」という文字を考えてみましょう：

```
    ┌─────────┐
    │  ┌───┐  │
    │  │   │  │  ← 「O」は外側の円と内側の円の
    │  │   │  │     2つの輪郭でできている
    │  └───┘  │
    └─────────┘
```

- **外側の輪郭**: 文字の外形
- **内側の輪郭**: 穴（hole）を表す

### 複雑な文字の例

「B」のような文字はさらに複雑です：

```
    ┌──────┐
    │ ┌──┐ │     ← 上の穴
    │ └──┘ │
    │ ┌──┐ │     ← 下の穴
    │ └──┘ │
    └──────┘
         ↑
       外枠（ベース）
```

「B」は3つの輪郭で構成されています：
- 1つの外枠（最も大きい）
- 2つの穴（上下の空白部分）

## ot2paveのアルゴリズム

### 4つのフェーズ

```
Phase 1: パス収集
    ↓
Phase 2: 面積でソート
    ↓
Phase 3: ベース決定
    ↓
Phase 4: 順次統合
```

### Phase 1: パス収集

OpenType.jsから受け取ったコマンド（moveTo, lineTo, bezierCurveTo など）を解析して、個別の閉じたパスに変換します。

```
コマンド列:
  M 0,0 → L 100,0 → L 100,100 → L 0,100 → Z
  M 20,20 → L 80,20 → L 80,80 → L 20,80 → Z

          ↓ 変換

パスリスト:
  Path 1: 外側の四角形
  Path 2: 内側の四角形
```

### Phase 2: 面積でソート

収集したパスを面積の大きい順に並べ替えます。

```
ソート前: [小パス, 大パス, 中パス]
    ↓
ソート後: [大パス, 中パス, 小パス]
```

**なぜソートするのか？**

最も大きいパスが「ベース」（外枠）である可能性が高いからです。

### Phase 3: ベース決定

最初のパス（最大面積）をベースとして設定します。

```
ベースパス: ████████████
            █          █
            █          █
            █          █
            ████████████
```

### Phase 4: 順次統合

残りのパスを順番にベースに統合していきます。統合の方法は「巻き方向」（Winding Direction）で決まります。

## 巻き方向（Winding Direction）とは

パスを構成する点を順番に追っていく方向です。

```
時計回り（CW）        反時計回り（CCW）
    1→2                  1→4
    ↓ ↓                  ↓ ↓
    4←3                  2←3
```

### 巻き方向と操作の関係

| ベースの巻き方向 | 対象パスの巻き方向 | 操作 |
|-----------------|-------------------|------|
| 同じ            | 同じ              | UNITE（合体） |
| 異なる          | 異なる            | SUBTRACT（穴を開ける） |

例えば「O」の場合：
- 外側の円: 時計回り（CW）→ ベース
- 内側の円: 反時計回り（CCW）→ 穴として引く

## 視覚的な処理フロー

「O」を処理する例：

```
Step 1: ベースを設定
    ████████
    ████████
    ████████  ← 塗りつぶされた円
    ████████
    ████████

Step 2: 穴を引く（SUBTRACT）
    ████████
    ██    ██
    ██    ██  ← 内側が空洞になった
    ██    ██
    ████████

完成！
```

「B」を処理する例：

```
Step 1: ベースを設定
    ████████
    ████████
    ████████  ← 外枠
    ████████
    ████████

Step 2: 上の穴を引く
    ████████
    ██  ████
    ████████
    ████████
    ████████

Step 3: 下の穴を引く
    ████████
    ██  ████
    ████████  ← 完成！
    ██  ████
    ████████
```

## 使用例

```javascript
import { ot2pave } from 'p5.pave2riso'

// OpenType.jsからコマンドを取得
const font = await opentype.load('font.otf')
const path = font.getPath('A', 0, 0, 72)
const commands = path.commands

// Pave.jsパスに変換
const pavePath = ot2pave(commands, { fontSize: 72 })

// 描画に使用
pave2Riso(pavePath, channel, options)
```

## オプション

| オプション | 説明 | デフォルト |
|-----------|------|-----------|
| `fontSize` | フォントサイズ | 必須 |
| `letterSpacing` | 文字間隔（em単位） | `0` |
| `precision` | パス近似の精度 | `0.1` |
| `debug` | デバッグ情報を出力 | `false` |

## 関連ファイル

- `src/utils/font-utils.ts` - 実装コード
- `src/types/font.ts` - 型定義

## 技術的な詳細

より詳しい実装の解説は、ソースコード内のコメントを参照してください。

主要なヘルパー関数：
- `getPathArea()` - パスの面積を計算
- `getPathWindingDirection()` - 巻き方向を判定
- `determinePathOperation()` - UNITE/SUBTRACTを決定
